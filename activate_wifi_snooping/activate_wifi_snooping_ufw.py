#!/usr/bin/python3

# dummys 2020
# inf0junki3, 2016.
# This is a quick script to set yourself up for wifi snooping. I use it during mobile pentests to 
# quickly enable/disable MITM conditions.
# *Prerequisites:* iptables, dnsmasq, and hostapd. I have provided sample basic config files.
# IMPORTANT: if you do use the basic config files, GO OVER THEM AND CUSTOMIZE AT LEAST THE SSID AND
# PASSWORD FIRST.
# Final "heads-up" - I'm not doing any input sanitization here, careful what you put in the config
# files and what you pass as arguments.

import          argparse
from os import  geteuid
from os import  path
import          sys
from os import  system
import          signal

DEFAULT_GATEWAY     = "10.0.50.1"
DEFAULT_WIFI        = "wlan0"
DEFAULT_WIRED       = "eth0"
DNSMASQ_BIN         = "/usr/bin/dnsmasq"
HOSTAPD_BIN         = "/usr/bin/hostapd"

parser = argparse.ArgumentParser(description = "Enable / Disable wifi snooping.")
parser.add_argument("dnsmasq_file", help="[Required] Full path to dnsmasq.conf")
parser.add_argument("hostapd_file", help="[Required] Full path to hostapd.conf")
parser.add_argument("--gateway", help="[Optional] wifi interface. Default: 10.0.50.1",
                    default = DEFAULT_GATEWAY)
parser.add_argument("--wifi_if", help="[Optional] wifi interface. Default: wlan0",
                    default = DEFAULT_WIFI)
parser.add_argument("--wire_if", help="[Optional] wired interface. Default: eth0",
                    default = DEFAULT_WIRED)
parser.add_argument("--redirect_http_port", help="[Optional] Redirect HTTP traffic to proxy. Default: None",
                    default = None)

def run_commands(commands):
    for command in commands:
        system(command)

def setup(dnsmasq_file,
          hostapd_file,
          gateway,
          wifi_if,
          wired_if,
          redirect_http_port):
    commands = ["sysctl net.ipv4.ip_forward=1",
                f"ufw route allow in on {wifi_if} out on {wired_if}",
                # deny all dhcp request on wired if to avoid mess
                f"ufw insert 1 deny in on {wired_if} from any port 67 proto udp",
                # need to keep it due to ufw not implementing nat so far 
                f"iptables -t nat -A POSTROUTING -o {wired_if} -j MASQUERADE",
                f"ip addr add dev {wifi_if} {gateway}/24",
                f"{DNSMASQ_BIN} -C {dnsmasq_file} &",
                f"{HOSTAPD_BIN} {hostapd_file} &"]
    if redirect_http_port is not None:
        redir_http = f"iptables -t nat -A PREROUTING -p tcp -i {wifi_if} \
                --dport 80:443 -j REDIRECT --to-ports {redirect_http_port}"
        commands.append(redir_http)
    run_commands(commands)
    print("Setup done. Press Ctrl + C to tear down.")

def teardown(dnsmasq_file,
             hostapd_file,
             gateway,
             wifi_if,
             wired_if,
             redirect_http_port):
    commands = ["killall dnsmasq".format(DNSMASQ_BIN, dnsmasq_file),
                "sysctl net.ipv4.ip_forward=0",
                f"ufw delete deny in on {wired_if} from any port 67 proto udp",
                f"ufw route delete allow in on {wifi_if} out on {wired_if}",
                f"iptables -t nat -D POSTROUTING -o {wired_if} -j MASQUERADE",
                f"ip addr del dev {wifi_if} {gateway}/24",
                "killall {}".format(path.basename(HOSTAPD_BIN))]
    if redirect_http_port is not None:
        redir_http = "iptables -t nat -D PREROUTING -p tcp -i {wifi_if} \
                --dport 80:443 -j REDIRECT --to-ports {redirect_http_port}"
        commands.append(redir_http)
    run_commands(commands)

def teardown_handler(signal, frame):
    print("\nTearing down settings.")
    teardown(args.dnsmasq_file,
             args.hostapd_file,
             args.gateway,
             args.wifi_if,
             args.wire_if,
             args.redirect_http_port)
    print("Tear down done. Exiting.")
    sys.exit(0)

#MAIN:
if __name__ == "__main__":
    if geteuid() != 0:
        print("You must be root to run this script. Exiting.")
        sys.exit(1)
    args = parser.parse_args()
    setup(args.dnsmasq_file,
          args.hostapd_file,
          args.gateway,
          args.wifi_if,
          args.wire_if,
          args.redirect_http_port)
    signal.signal(signal.SIGINT, teardown_handler)
    signal.pause()
